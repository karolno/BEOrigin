---
title: "Figure 2: Characterisation of NSCJ cell types"
author: "Karol Nowicki-Osuch, based on Nils Eling's code"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float:
      toc_collapsed: true
    toc_depth: 3
    number_sections: false
    theme: paper
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script focuses on detecting new cell types at the junction between NG and NE. Figure S13 already covers some of that. 

# Read in the data

```{r libraries, message=FALSE}
library(scran)
library(scater)
library(DropletUtils)
library(openxlsx)
library(Rtsne)
library(pheatmap)
library(RColorBrewer)
library(edgeR)
library(viridis)
library(corrplot)
library(reshape2)
library(knitr)
library(ape)
library(gridExtra)
source("../Analysis/Functions/auxiliary.R")

sce <- readRDS("~/Dropbox/Postdoc/2019-12-29_BE2020/All_corrected_sce_filtered.rds")

sce$cell_type <- factor(sce$cell_type, levels = c(
  "Basal",
  "Suprabasal",
  "Intermediate",
  "Superficial",
  
  "Undifferentiated",
  "Endocrine",
  "Foveolar_Intermediate",
  "Foveolar_differentiated",
  "Parietal",
  "Chief",
  
  "Columnar_Undifferentiated",
  "Columnar_Intermediate",
  "Columnar_differentiated",
  
  "Enterocytes_Intermediate",
  "Enterocytes_differentiated",
  "Paneth",
  
  "Goblet",
  
  "KRT5_cells",
  "KRT5.KRT7_cells",
  "KRT7_cells",
  "MUC5B_cells",
  
  "Mucous",
  "Oncocytes",
  "Duct_Intercalating",
  "Myo-epithelial",
  "Unknown.Doublets",
  
  "Immune",
  "Stromal",
  "Squamous_Esophagus",
  "Novel"
))


sce <- sce[,sce$include]
```

## Marker genes expression

Here, we perform pairwise DE testing to find cluster specific marker genes.



# Visualize NSCJ

Here, I am only looking at the NSCJ samples. Here I am combining the data for all novel cluster. For the purpose of the figure the following cluster will be merged into the same colour. Actual clustering was performed in the initial analysis (see Preprocessing folder for 4.4_Tissue_correction_filtered.Rmd - clustering of tissue types and 5.4_Reclustering.Rmd for reclusting)

In the final manuscript we changed the names of clusters:
original names - new name
KRT5_cells - C1_cells
KRT5.KRT7_cells - C2_cells
KRT7_cells - C3_cells
MUC5B_cells - C4_cells

```{r}
# Select tissues to test
cur_sce <- sce[,sce$include & sce$Tissue %in% c("NSCJ")]

# Perform batch correction
sce.list <- split.sce(cur_sce, unique(cur_sce$Sample), colData.name = "Sample")

# order the samples by size of the sample 
sce.list <- sce.list[order(unlist(lapply(sce.list, ncol)), decreasing = TRUE)]

corrected <- batch.correction(sce.list)
cur_sce <- do.call("cbind", sce.list)

# Compute new tSNE 
set.seed(12345)
tsne <- Rtsne(t(corrected), pca = FALSE, perplexity = 100)
reducedDims(cur_sce)$TSNE <- tsne$Y


# Visualize tSNEs

# Temporarily rename the novel clusters
# For the purpose of the figure the following cluster will be merged into the same colour. Actual clustering was performed in the initial analysis (see Preprocessing folder for 4.4_Tissue_correction_filtered.Rmd - clustering of tissue types and 5.4_Reclustering.Rmd for reclusting)
cur_sce$cell_type[cur_sce$cell_type %in% c("MUC5B_cells", "KRT7_cells", "KRT5.KRT7_cells", "KRT5_cells")]<-"Novel"

# Cell type
colour_vector <- vector(length = length(unique(cur_sce$cell_type)))
names(colour_vector) <- unique(cur_sce$cell_type)
colour_vector["Superficial"] <- colorRampPalette(c("white", "dark red"))(10)[10]
colour_vector["Basal"] <- colorRampPalette(c("white", "dark red"))(10)[4]
colour_vector["Suprabasal"] <- colorRampPalette(c("white", "dark red"))(10)[6]
colour_vector["Intermediate"] <- colorRampPalette(c("white", "dark red"))(10)[8]

colour_vector["Foveolar_differentiated"] <- colorRampPalette(c("white", "#4DBBD5FF"))(10)[10]
colour_vector["Endocrine"] <- colorRampPalette(c("white", "dark blue"))(10)[10]
colour_vector["Undifferentiated"] <- colorRampPalette(c("white", "#4DBBD5FF"))(10)[3]
colour_vector["Foveolar_Intermediate"] <- colorRampPalette(c("white", "#4DBBD5FF"))(10)[6]
colour_vector["Immune"] <- "grey40"
colour_vector["Stromal"] <- "grey60"

colour_vector["Novel"] <- "orange"

# colour_vector["MUC5B_cells"] <- "saddlebrown"
# colour_vector["KRT7_cells"] <- "burlywood3"
# colour_vector["KRT5.KRT7_cells"] <- "burlywood4"
# colour_vector["KRT5_cells"] <- "orange"



p.all.cells.cell_type <- ggplot(data.frame(tsne1 = reducedDims(cur_sce)$TSNE[,1],
                                           tsne2 = reducedDims(cur_sce)$TSNE[,2],
                                           tissue = colData(cur_sce)$cell_type)) +
  geom_point(aes(tsne1, tsne2), colour = "black", size = 1) + 
  geom_point(aes(tsne1, tsne2, colour = tissue), size = 0.5) + 
  scale_color_manual(values = colour_vector) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.key = element_blank()) + 
  xlab("t-SNE 1")  + 
  ylab("t-SNE 2") + 
  guides(colour = guide_legend(override.aes = list(size=4), title = "Cell Type"))

p.all.cells.cell_type

ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/NSCJ_novel.pdf", p.all.cells.cell_type, width = 7, height = 5, useDingbats = FALSE)



#Get the expression values
genes<-c("MUC5B", "KRT7", "CHGA", "MUC5AC", "KRT8", "KRT4", "KRT14", "KRT5", "TP63", "PTPRC", "MUC2")

meanexpression <- aggregate(as.data.frame(t(as.matrix(logcounts(cur_sce)[rowData(cur_sce)$Symbol %in% genes,]))), list(colData(cur_sce)$cell_type), mean)
meanexpression <- melt(meanexpression)
colnames(meanexpression) <- c("Cell_type", "gene", "mean_expression")

propnozero <- function(x) {
  length(x[x>1])/length(x)
}

nonzeroexpression <- aggregate(as.data.frame(t(as.matrix(logcounts(cur_sce)[rowData(cur_sce)$Symbol %in% genes,]))), list(colData(cur_sce)$cell_type), propnozero)
nonzeroexpression <- melt(nonzeroexpression)
colnames(nonzeroexpression) <- c("Cell_type", "gene", "proportion")

expression.df <- merge(meanexpression, nonzeroexpression )
expression.df$gene <- rowData(cur_sce)$Symbol[match (expression.df$gene, rowData(cur_sce)$ID)]
expression.df$Cell_type <- factor(expression.df$Cell_type, levels = c("Immune", "Stromal", "Basal", "Suprabasal", "Intermediate", "Superficial", "Undifferentiated","Foveolar_Intermediate", "Foveolar_differentiated", "Endocrine", "Novel"  ))
expression.df$gene <- factor(expression.df$gene, levels = genes)

expression.df$Tissue_type <- NA
expression.df$Tissue_type[expression.df$Cell_type %in% c("Immune", "Stromal")] <- "Nonepithelial"
expression.df$Tissue_type[expression.df$Cell_type %in% c("Basal", "Suprabasal", "Intermediate", "Superficial")] <- "Oesophageal"
expression.df$Tissue_type[expression.df$Cell_type %in% c("Undifferentiated","Foveolar_Intermediate", "Foveolar_differentiated", "Endocrine")] <- "Gastric"
expression.df$Tissue_type[expression.df$Cell_type %in% c("Novel")] <- "Novel"
expression.df$mean_expression2 <- ifelse(expression.df$mean_expression >4, yes = 4, no = expression.df$mean_expression )


expression.plot <- ggplot(expression.df) + 
  geom_point(aes(y = gene, x = Cell_type, size = mean_expression2, colour = Tissue_type)) + 
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black")) +  
  scale_size_continuous(range=c(0, 6), limits = c(0,4), breaks = c(0,1,2,3,4)) +  
  scale_color_manual(values = c("#4DBBD5FF", "grey40", "orange", "darkred" ))+ 
  theme(axis.text.x=element_text(angle = 45, vjust = 1, hjust = 1))

print(expression.plot)

ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/NSCJ_expression.pdf", expression.plot, width = 4, height = 6, useDingbats = FALSE)

```




# Visualize NSCJ after reclustering

Here, I am only looking at the NSCJ samples and I will be using all cluster names. 
```{r}
# Restore cluster names
cur_sce <- do.call("cbind", sce.list)

reducedDims(cur_sce)$TSNE <- tsne$Y


# Cell type
colour_vector <- vector(length = length(unique(cur_sce$cell_type)))
names(colour_vector) <- unique(cur_sce$cell_type)
colour_vector["Superficial"] <- colorRampPalette(c("white", "dark red"))(10)[10]
colour_vector["Basal"] <- colorRampPalette(c("white", "dark red"))(10)[4]
colour_vector["Suprabasal"] <- colorRampPalette(c("white", "dark red"))(10)[6]
colour_vector["Intermediate"] <- colorRampPalette(c("white", "dark red"))(10)[8]

colour_vector["Foveolar_differentiated"] <- colorRampPalette(c("white", "#4DBBD5FF"))(10)[10]
colour_vector["Endocrine"] <- colorRampPalette(c("white", "dark blue"))(10)[10]
colour_vector["Undifferentiated"] <- colorRampPalette(c("white", "#4DBBD5FF"))(10)[3]
colour_vector["Foveolar_Intermediate"] <- colorRampPalette(c("white", "#4DBBD5FF"))(10)[6]
colour_vector["Immune"] <- "grey40"
colour_vector["Stromal"] <- "grey60"

# colour_vector["Novel"] <- "orange"

colour_vector["MUC5B_cells"] <- "saddlebrown"
colour_vector["KRT7_cells"] <- "burlywood3"
colour_vector["KRT5.KRT7_cells"] <- "burlywood4"
colour_vector["KRT5_cells"] <- "orange"



p.all.cells.cell_type_all <- ggplot(data.frame(tsne1 = reducedDims(cur_sce)$TSNE[,1],
                                           tsne2 = reducedDims(cur_sce)$TSNE[,2],
                                           tissue = colData(cur_sce)$cell_type)) +
  geom_point(aes(tsne1, tsne2), colour = "black", size = 1) + 
  geom_point(aes(tsne1, tsne2, colour = tissue), size = 0.5) + 
  scale_color_manual(values = colour_vector) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.key = element_blank()) + 
  xlab("t-SNE 1")  + 
  ylab("t-SNE 2") + 
  guides(colour = guide_legend(override.aes = list(size=4), title = "Cell Type"))

p.all.cells.cell_type_all

ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/NSCJ_all_types.pdf", p.all.cells.cell_type_all, width = 7, height = 5, useDingbats = FALSE)



#Get the expression values
genes<-c("MUC5B", "KRT7", "KRT5", "TP63", "CHGA", "MUC5AC", "KRT8", "KRT4", "KRT14", "PTPRC", "MUC2")

meanexpression <- aggregate(as.data.frame(t(as.matrix(logcounts(cur_sce)[rowData(cur_sce)$Symbol %in% genes,]))), list(colData(cur_sce)$cell_type), mean)
meanexpression <- melt(meanexpression)
colnames(meanexpression) <- c("Cell_type", "gene", "mean_expression")

propnozero <- function(x) {
  length(x[x>1])/length(x)
}

nonzeroexpression <- aggregate(as.data.frame(t(as.matrix(logcounts(cur_sce)[rowData(cur_sce)$Symbol %in% genes,]))), list(colData(cur_sce)$cell_type), propnozero)
nonzeroexpression <- melt(nonzeroexpression)
colnames(nonzeroexpression) <- c("Cell_type", "gene", "proportion")

expression.df <- merge(meanexpression, nonzeroexpression )
expression.df$gene <- rowData(cur_sce)$Symbol[match (expression.df$gene, rowData(cur_sce)$ID)]
expression.df$Cell_type <- factor(expression.df$Cell_type, levels = c("Immune", "Stromal", "Basal", "Suprabasal", "Intermediate", "Superficial", "Undifferentiated","Foveolar_Intermediate", "Foveolar_differentiated", "Endocrine", "KRT5_cells", "KRT5.KRT7_cells", "KRT7_cells", "MUC5B_cells"))
expression.df$gene <- factor(expression.df$gene, levels = genes)

expression.df$Tissue_type <- NA
expression.df$Tissue_type[expression.df$Cell_type %in% c("Immune", "Stromal")] <- "Nonepithelial"
expression.df$Tissue_type[expression.df$Cell_type %in% c("Basal", "Suprabasal", "Intermediate", "Superficial")] <- "Oesophageal"
expression.df$Tissue_type[expression.df$Cell_type %in% c("Undifferentiated","Foveolar_Intermediate", "Foveolar_differentiated", "Endocrine")] <- "Gastric"
expression.df$Tissue_type[expression.df$Cell_type %in% c("KRT5_cells", "KRT5.KRT7_cells", "KRT7_cells", "MUC5B_cells")] <- "Novel"
expression.df$mean_expression2 <- ifelse(expression.df$mean_expression >4, yes = 4, no = expression.df$mean_expression )


expression.plot_all <- ggplot(expression.df) + geom_point(aes(y = gene, x = Cell_type, size = mean_expression2, colour = Tissue_type)) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                                                                                                                                                        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +  scale_size_continuous(range=c(0, 3), limits = c(0,4), breaks = c(0,1,2,3,4)) +  scale_color_manual(values = c("#4DBBD5FF", "grey40", "orange", "darkred" ))+ theme(axis.text.x=element_text(angle = 45, vjust = 1, hjust = 1))
print(expression.plot_all)

ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/NSCJ_expression_all.pdf", expression.plot_all, width = 5, height = 6, useDingbats = FALSE)


# check if there is correlation with size factors
p.all.cells.size <- ggplot(data.frame(tsne1 = reducedDims(cur_sce)$TSNE[,1],
                                      tsne2 = reducedDims(cur_sce)$TSNE[,2],
                                      sf = sizeFactors(cur_sce))) +
  #geom_point(aes(tsne1, tsne2), colour = "black", size = 1) + 
  geom_point(aes(tsne1, tsne2, colour = sf), size = 0.5) +
  scale_colour_viridis(option = "A") +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))

p.all.cells.size

# check if there is correlation with transcript count
p.all.cells.tcounts <- ggplot(data.frame(tsne1 = reducedDims(cur_sce)$TSNE[,1],
                                         tsne2 = reducedDims(cur_sce)$TSNE[,2],
                                         total_count = log10(cur_sce$total_counts))) +
  #geom_point(aes(tsne1, tsne2), colour = "black", size = 1) + 
  geom_point(aes(tsne1, tsne2, colour = total_count), size = 0.5) +
  scale_colour_viridis(option = "A") +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))

p.all.cells.tcounts

# check if there is correlation with gene count
p.all.cells.fcounts <- ggplot(data.frame(tsne1 = reducedDims(cur_sce)$TSNE[,1],
                                         tsne2 = reducedDims(cur_sce)$TSNE[,2],
                                         feature_count = (cur_sce$total_features_by_counts))) +
  #geom_point(aes(tsne1, tsne2), colour = "black", size = 1) + 
  geom_point(aes(tsne1, tsne2, colour = feature_count), size = 0.5) +
  scale_colour_viridis(option = "A") +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))

p.all.cells.fcounts




# Visualize patient
# Colouring for patient
colour_patient <- vector(length = length(unique(cur_sce$Patient)))
names(colour_patient) <- unique(cur_sce$Patient)
colour_patient <- brewer.pal(11, "Set3")

p.all.cells.patient <- ggplot(data.frame(tsne1 = reducedDims(cur_sce)$TSNE[,1],
                                         tsne2 = reducedDims(cur_sce)$TSNE[,2],
                                         tissue = colData(cur_sce)$Patient)) +
  geom_point(aes(tsne1, tsne2), colour = "black", size = 1) + 
  geom_point(aes(tsne1, tsne2, colour = tissue), size = 0.5) + 
  scale_color_manual(values = colour_patient) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))
p.all.cells.patient





# marker expression
gene<-"MUC5B"
p.gene.expression<-ggplot(data.frame(tSNE1 =  reducedDims(cur_sce)$TSNE[,1],
                                     tSNE2 =  reducedDims(cur_sce)$TSNE[,2],
                                     gene = logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene,]))  +
  geom_point(aes(tSNE1, tSNE2, colour = gene), size = 0.5) + scale_colour_viridis(option = "A", name = "log2(Expr)") +
  guides(alpha=FALSE) + ggtitle(gene)  + theme(panel.grid.major = element_blank(), 
                                               panel.grid.minor = element_blank(),
                                               panel.background = element_blank(), 
                                               axis.line = element_line(colour = "grey"))
p.gene.expression

gene<-"KRT5"
p.gene.expression<-ggplot(data.frame(tSNE1 =  reducedDims(cur_sce)$TSNE[,1],
                                     tSNE2 =  reducedDims(cur_sce)$TSNE[,2],
                                     gene = logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene,]))  +
  geom_point(aes(tSNE1, tSNE2, colour = gene), size = 0.5) + scale_colour_viridis(option = "A", name = "log2(Expr)") +
  guides(alpha=FALSE) + ggtitle(gene) + theme(panel.grid.major = element_blank(), 
                                              panel.grid.minor = element_blank(),
                                              panel.background = element_blank(), 
                                              axis.line = element_line(colour = "grey"))
p.gene.expression
p.gene.expression

gene<-"KRT7"
p.gene.expression<-ggplot(data.frame(tSNE1 =  reducedDims(cur_sce)$TSNE[,1],
                                     tSNE2 =  reducedDims(cur_sce)$TSNE[,2],
                                     gene = logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene,]))  +
  geom_point(aes(tSNE1, tSNE2, colour = gene), size = 0.5) + scale_colour_viridis(option = "A", name = "log2(Expr)") +
  guides(alpha=FALSE) + ggtitle(gene) + theme(panel.grid.major = element_blank(), 
                                              panel.grid.minor = element_blank(),
                                              panel.background = element_blank(), 
                                              axis.line = element_line(colour = "grey"))
p.gene.expression
p.gene.expression

gene<-"TP63"
p.gene.expression<-ggplot(data.frame(tSNE1 =  reducedDims(cur_sce)$TSNE[,1],
                                     tSNE2 =  reducedDims(cur_sce)$TSNE[,2],
                                     gene = logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene,]))  +
  geom_point(aes(tSNE1, tSNE2, colour = gene), size = 0.5) + scale_colour_viridis(option = "A", name = "log2(Expr)") +
  guides(alpha=FALSE) + ggtitle(gene) + theme(panel.grid.major = element_blank(), 
                                              panel.grid.minor = element_blank(),
                                              panel.background = element_blank(), 
                                              axis.line = element_line(colour = "grey"))
p.gene.expression
p.gene.expression

gene1 <-"TP63"
gene2 <-"KRT7"
gene3 <-"KRT5"

clusters<-factor(rep(colData(cur_sce)$cell_type, 3))#, levels = as.character(as.factor(sort(as.numeric(unique(colData(cur_sce)$cell_type))))))
#get data for the second gene
all_data <- data.frame(gene = c(logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene1,],
                                logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene2,],
                                logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene3,]),
                       symbol = rep(c(gene1, gene2, gene3), each = ncol(cur_sce)),
                       tissue = factor(rep(colData(cur_sce)$Tissue, 3)),
                       clusters = clusters)


ggplot(all_data) + 
  geom_boxplot(aes(clusters, gene, fill = symbol)) + facet_wrap(. ~ tissue) + theme_bw()+ theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) 

library(GGally)
all_data <- data.frame(TP63 =   logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene1,],
                       KRT7 = logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene2,],
                       KRT5 =logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene3,],
                       MUC5B = logcounts(cur_sce)[rowData(cur_sce)$Symbol == "MUC5B",],
                       clusters = factor(cur_sce$cell_type)
)
ggscatmat(all_data, columns = 1:4, color = "clusters", ) + 
  scale_color_manual(values = colour_vector)

all_data2 <- all_data[all_data$KRT5 >0 & all_data$KRT7>0,]
# all_data2$clusters <- factor(all_data2$clusters)
ggscatmat(all_data2, columns = 1:4, color = "clusters", ) + 
  scale_color_manual(values = colour_vector)+
  ggtitle("KRT5 and KRT7 positive cells")
table(all_data2$clusters)/table(all_data$clusters)


all_data2 <- all_data[all_data$TP63 > 0 & all_data$KRT7 > 0,]
# all_data2$clusters <- factor(all_data2$clusters)
ggscatmat(all_data2, columns = 1:4, color = "clusters", ) + 
  scale_color_manual(values = colour_vector)+
  ggtitle("TP63 and KRT7 positive cells")
table(all_data2$clusters)/table(all_data$clusters)

all_data2 <- all_data[all_data$TP63 > 0 & all_data$KRT5 > 0,]
# all_data2$clusters <- factor(all_data2$clusters)
ggscatmat(all_data2, columns = 1:4, color = "clusters", ) + 
  scale_color_manual(values = colour_vector)+
  ggtitle("TP63 and KRT5 positive cells")
table(all_data2$clusters)/table(all_data$clusters)

all_data2 <- all_data[all_data$TP63 > 0 & all_data$KRT5 > 0 & all_data$KRT7 > 0,]
# all_data2$clusters <- factor(all_data2$clusters)
ggscatmat(all_data2, columns = 1:4, color = "clusters", ) + 
  scale_color_manual(values = colour_vector)+
  ggtitle("TP63, KRT5 and KRT7 positive cells")
table(all_data2$clusters)/table(all_data$clusters)


all_data2 <- all_data[all_data$clusters %in% c("KRT5_cells", "KRT5.KRT7_cells", "KRT7_cells", "MUC5B_cells"),]
# all_data2$clusters <- factor(all_data2$clusters)
ggscatmat(all_data2, columns = 1:4, color = "clusters", ) + 
  scale_color_manual(values = colour_vector)+
  ggtitle("Novel cell types only")

table(all_data2$clusters)/table(all_data$clusters)

all_data2 <- all_data[all_data$TP63 > 0 & all_data$KRT5 > 0 & all_data$KRT7 > 0 &all_data$clusters %in% c("KRT5_cells", "KRT5.KRT7_cells", "KRT7_cells", "MUC5B_cells"),]
# all_data2$clusters <- factor(all_data2$clusters)
ggscatmat(all_data2, columns = 1:4, color = "clusters", ) + 
  scale_color_manual(values = colour_vector)+
  ggtitle("TP63, KRT5 and KRT7 positive cells in novel cell types")
table(all_data2$clusters)/table(all_data$clusters)








gene1 <-"MUC5B"
gene2 <-"MUC5AC"
gene3 <-"MUC2"

clusters<-factor(rep(colData(cur_sce)$cell_type, 3))#, levels = as.character(as.factor(sort(as.numeric(unique(colData(cur_sce)$cell_type))))))
#get data for the second gene
all_data <- data.frame(gene = c(logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene1,],
                                logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene2,],
                                logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene3,]),
                       symbol = rep(c(gene1, gene2, gene3), each = ncol(cur_sce)),
                       tissue = factor(rep(colData(cur_sce)$Tissue, 3)),
                       clusters = clusters)


ggplot(all_data) + 
  geom_boxplot(aes(clusters, gene, fill = symbol)) + facet_wrap(. ~ tissue) + theme_bw()+ theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) 

gene1 <-"REG4"
gene2 <-"FABP1"
gene3 <-"CHGA"

clusters<-factor(rep(colData(cur_sce)$cell_type, 3))#, levels = as.character(as.factor(sort(as.numeric(unique(colData(cur_sce)$cell_type))))))
#get data for the second gene
all_data <- data.frame(gene = c(logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene1,],
                                logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene2,],
                                logcounts(cur_sce)[rowData(cur_sce)$Symbol == gene3,]),
                       symbol = rep(c(gene1, gene2, gene3), each = ncol(cur_sce)),
                       tissue = factor(rep(colData(cur_sce)$Tissue, 3)),
                       clusters = clusters)


ggplot(all_data) + 
  geom_boxplot(aes(clusters, gene, fill = symbol)) + facet_wrap(. ~ tissue) + theme_bw()+ theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) 


```


## Marker genes expression

Here, we perform pairwise DE testing to find cluster specific marker genes.

```{r}
# Remove non-expressed genes
cur_sce <- cur_sce[Matrix::rowSums(counts(cur_sce)) > 0,]

# Perform DE to find marker genes
DE.genes <- multi.DE(sce = cur_sce, 
                     conditions = cur_sce$cell_type_secondary,
                     covariate = cur_sce$Patient,
                     lfc = 0.5,
                     FDR = 0.1)

# Save as table
write.xlsx(DE.genes, file = "~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Supplemental_tables/Table_S3_NSCJ.xlsx")
```


# Visualised only the novel cell types

The data is already cluster so I will only visualise it.


```{r}
# Restore cluster names
cur_sce <- do.call("cbind", sce.list)
# Extract corrected dimensions for the selected cells and perform clustering
corrected2 <- corrected[,colData(cur_sce)$cell_type %in% c("KRT5_cells", "KRT5.KRT7_cells", "KRT7_cells", "MUC5B_cells")]

# Compute new tSNE
set.seed(12345)
tsne2 <- Rtsne(t(corrected2), pca = FALSE, perplexity = 10)


cur_sce <- cur_sce[,colData(cur_sce)$cell_type %in% c("KRT5_cells", "KRT5.KRT7_cells", "KRT7_cells", "MUC5B_cells")]
reducedDims(cur_sce)$TSNE <- tsne2$Y

## 212 cells


# Plot the patient data
cur_p <- ggplot(data.frame(tSNE1 = reducedDims(cur_sce)$TSNE[,1],
                           tSNE2 = reducedDims(cur_sce)$TSNE[,2],
                           clusters = as.factor(colData(cur_sce)$Patient))) +
  geom_point(aes(tSNE1, tSNE2, colour = clusters))
print(cur_p)


# Visualise the clustering results
cur_p <- ggplot(data.frame(tSNE1 = reducedDims(cur_sce)$TSNE[,1],
                           tSNE2 = reducedDims(cur_sce)$TSNE[,2],
                           clusters = as.factor(colData(cur_sce)$cell_type))) +
  geom_point(aes(tSNE1, tSNE2, colour = clusters))
print(cur_p)




# Visualize whether populations are patient specific 
print(kable(table(colData(cur_sce)$cell_type, colData(cur_sce)$Patient),row.names = TRUE))
cat("\n")



# Cell type
colour_vector <- vector(length = length(unique(cur_sce$cell_type)))
names(colour_vector) <- unique(cur_sce$cell_type)

colour_vector["MUC5B_cells"] <- "saddlebrown"
colour_vector["KRT7_cells"] <- "burlywood3"
colour_vector["KRT5.KRT7_cells"] <- "burlywood4"
colour_vector["KRT5_cells"] <- "orange"



p.all.cells.cell_type_small <- ggplot(data.frame(tsne1 = reducedDims(cur_sce)$TSNE[,1],
                                           tsne2 = reducedDims(cur_sce)$TSNE[,2],
                                           tissue = colData(cur_sce)$cell_type)) +
  geom_point(aes(tsne1, tsne2), colour = "black", size = 1.5) + 
  geom_point(aes(tsne1, tsne2, colour = tissue), size = 1.3) + 
  scale_color_manual(values = colour_vector) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.key = element_blank()) + 
  xlab("t-SNE 1")  + 
  ylab("t-SNE 2") + 
  guides(colour = guide_legend(override.aes = list(size=4), title = "Cell Type"))

p.all.cells.cell_type_small

ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/NSCJ_only_novel.pdf", p.all.cells.cell_type_small, width = 7, height = 5, useDingbats = FALSE)


#Get the expression values
genes<-c("MUC5B", "KRT7", "KRT5", "TP63", "CHGA", "MUC5AC", "KRT8", "KRT4", "KRT14", "PTPRC", "MUC2")

meanexpression <- aggregate(as.data.frame(t(as.matrix(logcounts(cur_sce)[rowData(cur_sce)$Symbol %in% genes,]))), list(colData(cur_sce)$cell_type), mean)
meanexpression <- melt(meanexpression)
colnames(meanexpression) <- c("Cell_type", "gene", "mean_expression")

propnozero <- function(x) {
  length(x[x>1])/length(x)
}

nonzeroexpression <- aggregate(as.data.frame(t(as.matrix(logcounts(cur_sce)[rowData(cur_sce)$Symbol %in% genes,]))), list(colData(cur_sce)$cell_type), propnozero)
nonzeroexpression <- melt(nonzeroexpression)
colnames(nonzeroexpression) <- c("Cell_type", "gene", "proportion")

expression.df <- merge(meanexpression, nonzeroexpression )
expression.df$gene <- rowData(cur_sce)$Symbol[match (expression.df$gene, rowData(cur_sce)$ID)]
expression.df$Cell_type <- factor(expression.df$Cell_type, levels = c("KRT5_cells", "KRT5.KRT7_cells", "KRT7_cells", "MUC5B_cells"))
expression.df$gene <- factor(expression.df$gene, levels = genes)

expression.df$Tissue_type <- NA
expression.df$Tissue_type[expression.df$Cell_type %in% c("KRT5_cells", "KRT5.KRT7_cells", "KRT7_cells", "MUC5B_cells")] <- "Novel"
expression.df$mean_expression2 <- ifelse(expression.df$mean_expression >4, yes = 4, no = expression.df$mean_expression )


expression.plot_small <- ggplot(expression.df) + geom_point(aes(y = gene, x = Cell_type, size = mean_expression2, colour = Tissue_type)) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
                                                                                                                                                        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +  scale_size_continuous(range=c(0, 10), limits = c(0,4), breaks = c(0,1,2,3,4)) +  scale_color_manual(values = c("orange"))+ theme(axis.text.x=element_text(angle = 45, vjust = 1, hjust = 1))
print(expression.plot_small)

ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/NSCJ_expression_only_novel.pdf", expression.plot_small, width = 5, height = 6, useDingbats = FALSE)


# Let make it into violin plots
#Get the expression values
genes<-c("MUC4", "MUC5B", "KRT7", "KRT5", "TP63")

nexpression <- cbind(as.data.frame(t(as.matrix(logcounts(cur_sce)[rowData(cur_sce)$Symbol %in% genes,]))), colData(cur_sce)$cell_type)

colnames(nexpression) <- c(rowData(cur_sce)$Symbol[match (colnames(nexpression)[1:ncol(nexpression)-1], rowData(cur_sce)$ID)], "Cell_type")

df.violin <- melt(nexpression, variable.name = "Gene", value.name = "Expression", id.vars = ncol(nexpression))
# df.violin$Cell_type <- factor(df.violin$Cell_type, levels = rev(levels(df.violin$Cell_type)))
df.violin$Gene <- factor(df.violin$Gene, levels = rev(genes))

expression.plot_violin <- ggplot(df.violin, aes(x = Cell_type, y = Expression, fill = Cell_type)) + 
  geom_violin(scale = "width", trim = TRUE, size = 0.1) + 
  geom_jitter(height = 0, width = 0.15, size = 0.05) +
  facet_wrap(~ Gene, ncol = 1, scales = "free_y") + 
  scale_fill_manual(values = colour_vector) + 
  theme_minimal() +
  ylab("Log2(Expression)") + 
  #coord_flip() +
  scale_y_continuous(breaks = scales::pretty_breaks(4)) +
  theme(legend.position = "none",
        axis.text.x=element_text(angle = 45, vjust = 1, hjust = 1),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank())

expression.plot_violin


ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/NSCJ_expression_only_novel_violin.pdf", expression.plot_violin, width = 3, height = 6, useDingbats = FALSE)











lay <- rbind(c(1,1,2),
             c(1,1,2),
             c(1,1,4),
             c(1,1,4),
             c(3,3,4),
             c(3,3,NA)
)

all.figures <- grid.arrange(p.all.cells.cell_type, p.all.cells.cell_type_small, expression.plot, expression.plot_small, layout_matrix=lay)

ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/NSCJ_combined.pdf", all.figures, width = 16, height = 12, useDingbats = FALSE)

lay <- rbind(c(1,1,2),
             c(1,1,2),
             c(1,1,4),
             c(1,1,4),
             c(3,3,4),
             c(3,3,4)
)

all.figures2 <- grid.arrange(p.all.cells.cell_type, p.all.cells.cell_type_small, expression.plot, expression.plot_violin, layout_matrix=lay)

ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/NSCJ_combined_violin.pdf", all.figures2, width = 16, height = 12, useDingbats = FALSE)


lay <- rbind(c(1,1,1,1,2,2,2),
            # c(1,1,1,1,2,2,2,2),
             c(1,1,1,1,3,3,4),
             c(1,1,1,1,3,3,4)
)

lay <- rbind(c(1,1,1),
             c(1,1,1),
             c(2,2,3),
             c(2,2,3),
             c(2,2,3)
)

p.all.cells.cell_type_small + theme(legend.position = c(0.8, 0.2))

expression.plot 


all.figures3 <- grid.arrange(  expression.plot+  scale_size_continuous(range=c(0, 4), limits = c(0,4), breaks = c(0,1,2,3,4)), p.all.cells.cell_type_small + theme(legend.position = c(0.8, 0.2)), expression.plot_violin, layout_matrix=lay)

ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/NSCJ_combined_violin_2.pdf", all.figures3, width = 10, height = 9, useDingbats = FALSE)



```

# Visualize SMG, NSCJ, NG and NE samples

Here I will visualise all the upper GI tissues and compare the NSCJ samples with pure tissue types. This should tell us something about the similarity of the novel cell types to the existing cell types.

```{r}
# Select tissues to test
cur_sce <- sce[,sce$include & sce$Tissue %in% c("SMG", "NG", "NSCJ", "NE")]


# Perform batch correction
sce.list <- split.sce(cur_sce, unique(cur_sce$Sample), colData.name = "Sample")
# order the samples by size of the sample 
sce.list <- sce.list[order(unlist(lapply(sce.list, ncol)), decreasing = TRUE)]

# order the samples
n <- names(sce.list)
sce.list <- sce.list[c(which(grepl("NSCJ_out", n)), which(grepl("NE_out", n)), 
                       which(grepl("NG_out", n)), which(grepl("SMG_out", n)))]

# The samples are in NSCJ, NE, NG, SMG order  
corrected <- batch.correction(sce.list)
cur_sce <- do.call("cbind", sce.list)

# Compute new tSNE
set.seed(12345)
tsne <- Rtsne(t(corrected), pca = FALSE, perplexity = 100)
reducedDims(cur_sce)$TSNE <- tsne$Y



# Clustering on corrected data
g <- buildSNNGraph(corrected, k = 10)
clusters <- igraph::cluster_louvain(g)$membership

# Check what clusters overlap with nonepithelial cell types
tmp<-reshape2::dcast(plyr::count(cbind(clusters,cur_sce$tissue_type)), formula = x.clusters ~ x.V2, fill = 0)
tmp<-tmp$x.clusters[tmp$NonEpithelial == apply(as.matrix(tmp[,2:5]), 1, max)]
# View(tmp)
# Exclude immune and stromal clusters
ImmuneTF <- clusters
ImmuneTF <- ifelse(ImmuneTF %in% tmp, "nonepi", "epi")

# Visualize clustering with low alpha for immune and stromal cells
ggplot(data.frame(tSNE1 = tsne$Y[,1],
                  tSNE2 = tsne$Y[,2],
                  clusters = as.factor(clusters),
                  ImmuneTF =ImmuneTF)) + 
  geom_point(aes(tSNE1, tSNE2, colour = clusters, alpha = ImmuneTF), size = 0.5) +
  scale_alpha_manual(values = c("epi" = 1 , "nonepi" = 0.05)) 

#andomize the order of cells
jittered <- sample(ncol(cur_sce))

#add new colour for Novel cell types
colour_vector<-metadata(cur_sce)$colour_vector
colour_vector["NSCJ_novel"]<-"orange"
cur_sce$Tissue[cur_sce$cell_type %in% c("MUC5B_cells", "KRT7_cells", "KRT5.KRT7_cells", "KRT5_cells")]<-"NSCJ_novel"

# Visualize tsne
p.all.cells <- ggplot(data.frame(tsne1 = reducedDims(cur_sce)$TSNE[jittered,1],
                                 tsne2 = reducedDims(cur_sce)$TSNE[jittered,2],
                                 tissue = colData(cur_sce)$Tissue[jittered],
                                 ImmuneTF =ImmuneTF[jittered])) + 
  geom_point(aes(tsne1, tsne2, alpha = ImmuneTF), colour = "black", size = 1) + 
  geom_point(aes(tsne1, tsne2, colour = tissue, alpha = ImmuneTF), size = 0.5) + 
  scale_color_manual(values = colour_vector) + 
  scale_alpha_manual(values = c("epi" = 1 , "nonepi" = 0.05)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.key = element_blank()
  ) + 
  xlab("t-SNE 1")  + 
  ylab("t-SNE 2") + 
  guides(colour = guide_legend(override.aes = list(size=4), title = "Tissue Type"),
         alpha = guide_legend(override.aes = list(size=4), title = "Cell Type")
  )

p.all.cells



ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/All_tissue_types-tsne.pdf", p.all.cells, width = 7, height = 5, useDingbats = FALSE)

# restore annotation
cur_sce$Tissue[cur_sce$cell_type %in% c("MUC5B_cells", "KRT7_cells", "KRT5.KRT7_cells", "KRT5_cells")]<-"NSCJ"


# Tissue types
p.all.cells.tissue_type <- ggplot(data.frame(tsne1 = reducedDims(cur_sce)$TSNE[jittered,1],
                                             tsne2 = reducedDims(cur_sce)$TSNE[jittered,2],
                                             tissue = colData(cur_sce)$tissue_type[jittered])) +
  geom_point(aes(tsne1, tsne2), colour = "black", size = 1) + 
  geom_point(aes(tsne1, tsne2, colour = tissue), size = 0.5) + 
  scale_color_manual(values = c("darkblue", "grey40", "darkred", "orange" )) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.key = element_blank()) + xlab("t-SNE 1")  + ylab("t-SNE 2") + guides(colour = guide_legend(override.aes = list(size=4), title = "Cell Type"))

p.all.cells.tissue_type

# Cell type
colour_vector <- vector(length = length(unique(cur_sce$cell_type)))
names(colour_vector) <- unique(cur_sce$cell_type)
colour_vector["Superficial"] <- colorRampPalette(c("white", "dark red"))(10)[10]
colour_vector["Basal"] <- colorRampPalette(c("white", "dark red"))(10)[4]
colour_vector["Suprabasal"] <- colorRampPalette(c("white", "dark red"))(10)[6]
colour_vector["Intermediate"] <- colorRampPalette(c("white", "dark red"))(10)[8]

colour_vector["Foveolar_differentiated"] <- colorRampPalette(c("white", "#4DBBD5FF"))(10)[10]
colour_vector["Endocrine"] <- colorRampPalette(c("white", "dark blue"))(10)[10]
colour_vector["Undifferentiated"] <- colorRampPalette(c("white", "#4DBBD5FF"))(10)[3]
colour_vector["Foveolar_Intermediate"] <- colorRampPalette(c("white", "#4DBBD5FF"))(10)[6]
colour_vector["Chief"] <- colorRampPalette(c("white", "dark blue"))(10)[6]
colour_vector["Parietal"] <- colorRampPalette(c("white", "dark blue"))(10)[3]
colour_vector["Immune"] <- "grey40"
colour_vector["Stromal"] <- "grey60"
colour_vector["Mucous"] <- "saddlebrown"
colour_vector["Oncocytes"] <- "burlywood3"
colour_vector["Myo-epithelial"] <- "brown"
colour_vector["Duct_Intercalating"] <- "burlywood4"

colour_vector["MUC5B_cells"] <- "saddlebrown"
colour_vector["KRT7_cells"] <- "burlywood3"
colour_vector["KRT5.KRT7_cells"] <- "burlywood4"
colour_vector["KRT5_cells"] <- "orange"


p.all.cells.cell_type <- ggplot(data.frame(tsne1 = reducedDims(cur_sce)$TSNE[jittered,1],
                                           tsne2 = reducedDims(cur_sce)$TSNE[jittered,2],
                                           tissue = colData(cur_sce)$cell_type[jittered])) +
  geom_point(aes(tsne1, tsne2), colour = "black", size = 1) + 
  geom_point(aes(tsne1, tsne2, colour = tissue), size = 0.5) + 
  scale_color_manual(values = colour_vector) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.background = element_blank(),
        legend.key = element_blank()
  ) + 
  xlab("t-SNE 1")  + 
  ylab("t-SNE 2") + 
  guides(colour = guide_legend(override.aes = list(size=4), title = "Cell Type")
  )

p.all.cells.cell_type

ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/All_cell_types-tsne.pdf", p.all.cells.cell_type, width = 7, height = 5, useDingbats = FALSE)

# Visualize patient
# Colouring for patient
colour_patient <- vector(length = length(unique(cur_sce$Patient)))
names(colour_patient) <- unique(cur_sce$Patient)
colour_patient <- brewer.pal(12, "Set3")

p.all.cells.patient <- ggplot(data.frame(tsne1 = reducedDims(cur_sce)$TSNE[,1],
                                         tsne2 = reducedDims(cur_sce)$TSNE[,2],
                                         tissue = colData(cur_sce)$Patient)) +
  geom_point(aes(tsne1, tsne2), colour = "black", size = 1) + 
  geom_point(aes(tsne1, tsne2, colour = tissue), size = 0.5) + 
  scale_color_manual(values = colour_patient) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))
p.all.cells.patient

#Get the expression values
genes<-c("MUC5B", "KRT7", "KRT5", "TP63", "CHGA", "MUC5AC", "KRT8", "KRT4", "KRT14", "PTPRC", "MUC2")

meanexpression <- aggregate(as.data.frame(t(as.matrix(logcounts(cur_sce)[rowData(cur_sce)$Symbol %in% genes,]))), list(paste(colData(cur_sce)$Tissue, colData(cur_sce)$cell_type, sep = "_")), mean)
meanexpression <- melt(meanexpression)
colnames(meanexpression) <- c("Cell_type", "gene", "mean_expression")

propnozero <- function(x) {
  length(x[x>1])/length(x)
}

nonzeroexpression <- aggregate(as.data.frame(t(as.matrix(logcounts(cur_sce)[rowData(cur_sce)$Symbol %in% genes,]))), list(paste(colData(cur_sce)$Tissue, colData(cur_sce)$cell_type, sep = "_")), propnozero)
nonzeroexpression <- melt(nonzeroexpression)
colnames(nonzeroexpression) <- c("Cell_type", "gene", "proportion")

expression.df <- merge(meanexpression, nonzeroexpression )
expression.df$gene <- rowData(cur_sce)$Symbol[match (expression.df$gene, rowData(cur_sce)$ID)]
expression.df <- expression.df[!grepl("Immune|Stromal", expression.df$Cell_type),]
expression.df$Cell_type <- factor(expression.df$Cell_type, levels = c("NE_Basal", "NE_Suprabasal", "NE_Intermediate", "NE_Superficial",
                                                                      "NG_Undifferentiated","NG_Foveolar_Intermediate", "NG_Foveolar_differentiated", "NG_Endocrine", "NG_Parietal", "NG_Chief",
                                                                      "NSCJ_Basal", "NSCJ_Suprabasal", "NSCJ_Intermediate", "NSCJ_Superficial", "NSCJ_Undifferentiated","NSCJ_Foveolar_Intermediate", "NSCJ_Foveolar_differentiated", "NSCJ_Endocrine", "NSCJ_KRT5_cells", "NSCJ_KRT5.KRT7_cells", "NSCJ_KRT7_cells", "NSCJ_MUC5B_cells",
                                                                      "SMG_Duct_Intercalating", "SMG_Mucous", "SMG_Oncocytes", "SMG_Myo-epithelial"))
expression.df$gene <- factor(expression.df$gene, levels = genes)

expression.df$Tissue_type <- NA
expression.df$Tissue_type[grepl("Basal|Suprabasal|Intermediate|Superficial", expression.df$Cell_type)] <- "Oesophageal"
expression.df$Tissue_type[expression.df$Cell_type %in% c("Undifferentiated","Foveolar_Intermediate", "Foveolar_differentiated", "Endocrine")] 
expression.df$Tissue_type[grepl("Undifferentiated|Foveolar_Intermediate|Foveolar_differentiated|Endocrine|Chief|Parietal", expression.df$Cell_type)] <- "Gastric" 
expression.df$Tissue_type[grepl("KRT|MUC5B", expression.df$Cell_type)]<- "Novel"
expression.df$Tissue_type[grepl("SMG", expression.df$Cell_type)]<- "SMG"



expression.df$mean_expression2 <- ifelse(expression.df$mean_expression >4, yes = 4, no = expression.df$mean_expression )


expression.plot <- ggplot(expression.df) + 
  geom_point(aes(y = gene, x = Cell_type, size = mean_expression2, colour = Tissue_type)) + 
  theme_bw() + 
  theme(panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black")
  ) +
  scale_size_continuous(range=c(0, 3), limits = c(0,4), breaks = c(0,1,2,3,4)) + 
  scale_color_manual(values = c("#4DBBD5FF", "orange", "darkred","#B09C85FF" )) +
  theme(axis.text.x=element_text(angle = 45, vjust = 1, hjust = 1)) +
  guides(colour = guide_legend(override.aes = list(size=4), title = "Tissue Type"),
         size = guide_legend(title = "Mean Expression"))

print(expression.plot)

ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/All_tissues_expression.pdf", expression.plot, width = 6, height = 6, useDingbats = FALSE)

# Let's do the same but merge the tissue types and just look at cell types

#Get the expression values
genes<-c("MUC5B", "KRT7", "KRT5", "TP63", "CHGA", "MUC5AC", "KRT8", "KRT4", "KRT14", "PTPRC", "MUC2")

meanexpression <- aggregate(as.data.frame(t(as.matrix(logcounts(cur_sce)[rowData(cur_sce)$Symbol %in% genes,]))), list(colData(cur_sce)$cell_type), mean)
meanexpression <- melt(meanexpression)
colnames(meanexpression) <- c("Cell_type", "gene", "mean_expression")

propnozero <- function(x) {
  length(x[x>1])/length(x)
}

nonzeroexpression <- aggregate(as.data.frame(t(as.matrix(logcounts(cur_sce)[rowData(cur_sce)$Symbol %in% genes,]))), list(colData(cur_sce)$cell_type), propnozero)
nonzeroexpression <- melt(nonzeroexpression)
colnames(nonzeroexpression) <- c("Cell_type", "gene", "proportion")

expression.df <- merge(meanexpression, nonzeroexpression )
expression.df$gene <- rowData(cur_sce)$Symbol[match (expression.df$gene, rowData(cur_sce)$ID)]
expression.df$Cell_type <- factor(expression.df$Cell_type, levels = c("Immune", "Stromal", "Basal", "Suprabasal", "Intermediate", "Superficial", "Undifferentiated","Foveolar_Intermediate", "Foveolar_differentiated", "Endocrine", "Chief", "Parietal", "KRT5_cells", "KRT5.KRT7_cells", "KRT7_cells", "MUC5B_cells", "Duct_Intercalating", "Mucous", "Oncocytes", "Myo-epithelial"))
expression.df$gene <- factor(expression.df$gene, levels = genes)

expression.df$Tissue_type <- NA
expression.df$Tissue_type[expression.df$Cell_type %in% c("Immune", "Stromal")] <- "Nonepithelial"
expression.df$Tissue_type[expression.df$Cell_type %in% c("Basal", "Suprabasal", "Intermediate", "Superficial")] <- "Oesophageal"
expression.df$Tissue_type[expression.df$Cell_type %in% c("Undifferentiated","Foveolar_Intermediate", "Foveolar_differentiated", "Endocrine","Chief", "Parietal")] <- "Gastric"
expression.df$Tissue_type[expression.df$Cell_type %in% c("KRT5_cells", "KRT5.KRT7_cells", "KRT7_cells", "MUC5B_cells")] <- "Novel"
expression.df$Tissue_type[expression.df$Cell_type %in% c("Duct_Intercalating", "Mucous", "Oncocytes", "Myo-epithelial")] <- "SMG"

expression.df$mean_expression2 <- ifelse(expression.df$mean_expression >4, yes = 4, no = expression.df$mean_expression )


expression.plot <- ggplot(expression.df) + 
  geom_point(aes(y = gene, x = Cell_type, size = mean_expression2, colour = Tissue_type)) + 
  theme_bw() + 
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), 
    axis.line = element_line(colour = "black")
  ) +
  scale_size_continuous(range=c(0, 3), limits = c(0,4), breaks = c(0,1,2,3,4)) +
  scale_color_manual(values = c("#4DBBD5FF", "grey40", "orange", "darkred", "#B09C85FF")) +
  theme(axis.text.x=element_text(angle = 45, vjust = 1, hjust = 1)) +
  guides(
    colour = guide_legend(override.aes = list(size=4), title = "Tissue Type"),
    size = guide_legend(title = "Mean Expression")
  )



print(expression.plot)

ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/All_tissues_expression_cell_types.pdf", expression.plot, width = 5, height = 6, useDingbats = FALSE)


```

# Plot circular dendrogram of all clusters

To estimate the similarity between all cell types, we compute an averaged expression profile for each cell-type and perform hierarchical cluster analysis.

```{r}
# We will perform this analysis on the corrected and uncorrected counts (uncorrected in supplements)
clusters <- paste(colData(cur_sce)$Tissue, colData(cur_sce)$Tissue_cluster, sep = "_")
mat <- matrix(data = NA, ncol = length(unique(clusters)), nrow = nrow(corrected))
colnames(mat) <- unique(clusters)

for(i in unique(clusters)){
  mat[,i] <- rowMeans(corrected[,clusters == i])
}

# Rename the matrix to contain the actual cell-type labels
for(i in 1:ncol(mat)){
  colnames(mat)[i] <- unique(as.vector(cur_sce$cell_type[cur_sce$Tissue == sub("_[0-9]*$", "", colnames(mat)[i]) &
                                             cur_sce$Tissue_cluster == sub("^[A-Z2]*_", "", colnames(mat)[i])]))
}

# Calculate euclidean distance on corrected counts
dend <- hclust(dist(t(mat), method = "euclidean"), method = "ward.D2")
plot(as.phylo(dend), type = "fan", 
     tip.color = metadata(sce)$colour_vector[sub("_[0-9]*$", "", unique(clusters))])

dev.off()
pdf("/home/karolno/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Figure_2/Tree_corrected_counts.pdf", width = 10, height = 10, useDingbats = FALSE)
plot(as.phylo(dend), type = "fan", 
     tip.color = metadata(sce)$colour_vector[sub("_[0-9]*$", "", unique(clusters))])
dev.off()
```

# End matters




```{r}
sessionInfo()
```



