---
title: "Figure S5: Comparison of our data to Owen et al and HCA data"
author: "Karol Nowicki-Osuch based on Nils Eling's code"
date: "`r Sys.Date()`"
output: 
html_document:
    toc: true
    toc_float:
      toc_collapsed: true
    toc_depth: 3
    number_sections: false
    theme: paper
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script visualizes all cells obtained from the gland compartment.
Furthermore, it performs data comparison to data generated by Owen et al [link](https://www.nature.com/articles/s41467-018-06796-9/) and by the Teichmann lab for the Human Cell Atlas.

# Comparison to Owen et al.

```{r libraries, message=FALSE}
library(scran)
library(scater)
library(DropletUtils)
library(openxlsx)
library(Rtsne)
library(pheatmap)
library(viridis)
library(RColorBrewer)
library(umap)
source("../../Analysis/Functions/auxiliary.R")
```

# Visualizing the gland cells

Here, we visualize the expression of marker genes in gland cells as well as stromal cells.

```{r}
# Read in our data
sce <- readRDS("~/Dropbox/Postdoc/2019-12-29_BE2020/All_corrected_sce_filtered.rds")

# Select gland cells
cur_sce <- sce[,sce$Tissue == "SMG"]

# Split the SCE object into individual patients
sce.list <- split.sce(cur_sce, unique(cur_sce$Patient), colData.name = "Patient")

# Order sce object by size
sce.list <- sce.list[order(unlist(lapply(sce.list, ncol)), decreasing = TRUE)]

# Perform batch correction
corrected <- batch.correction(sce.list)

# Merge sce objects
cur_sce <- do.call("cbind", sce.list)

# Create colour vecotr for glands
colour_vector <-  vector(length = length(unique(cur_sce$cell_type)))
names(colour_vector) <- unique(cur_sce$cell_type)
colour_vector["Immune"] <- "grey40"
colour_vector["Unknown.Doublets"] <- "white"
colour_vector["Mucous"] <- "saddlebrown"
colour_vector["Oncocytes"] <- "burlywood3"
colour_vector["Stromal"] <- "grey60"
# colour_vector["Nonepithelial"] <- "grey80"
colour_vector["Duct_Intercalating"] <- "burlywood4"
colour_vector["Squamous_Esophagus"] <- "black"
colour_vector["Myo-epithelial"] <- "brown"
# colour_vector["Dendritic"] <- "grey20"

# Remove non-expressed genes
cur_sce <- cur_sce[Matrix::rowSums(counts(cur_sce)) > 0,]

genes <- c("SLPI", "KRT7",
           "TFF3", "MUC5B", "AGR2", "KRT8",
           "MMP7", "SOX9", "CTNNB1", 
           "CDH1", "KRT23",
           "ACTA2", "KRT5", "TP63",
           "MKI67", "OLFM4")
 
# We first normalize gene expression across all selected cells
cur_sce <- computeSumFactors(cur_sce, clusters=cur_sce$cell_type)
cur_sce <- logNormCounts(cur_sce, log = TRUE)

# Remove somatic cells
for.heatmap <- logcounts(cur_sce)[match(genes, rowData(cur_sce)$Symbol),]
colnames(for.heatmap) <- paste(cur_sce$Barcode, cur_sce$Patient, sep = "_")

# Calculate euclidean distance using the factors after batch correction
euc.dist <- dist(t(corrected), method = "euclidean")

# Colouring for patient
patient_vector <- c("dark red", "dark blue", "dark green")
names(patient_vector) <- c("Patient10", "Patient11", "Patient13")

dev.off()
pdf(file = "/home/karolno/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Supplementary_figures/S5/SMG_heatmap_all.pdf", height = 7, width = 8, useDingbats = FALSE)
pheatmap(for.heatmap, cluster_rows = FALSE, color = viridis(100), 
         labels_row = genes, show_colnames = FALSE, clustering_distance_cols = euc.dist,
         annotation_col = data.frame(row.names = colnames(for.heatmap),
                                     cell_type = cur_sce$cell_type,
                                     cell_type_detailed = cur_sce$cell_type_secondary,
                                     patient = cur_sce$Patient), 
         annotation_colors = list(cell_type = colour_vector,
                                  patient = patient_vector))
dev.off()

```


# Comparison to Owen et al.

We will first read in the raw data and metadata from Owne et al.

```{r}
# Owen read counts
# owen.data <- read.table(url("https://static-content.springer.com/esm/art%3A10.1038%2Fs41467-018-06796-9/MediaObjects/41467_2018_6796_MOESM8_ESM.txt"))
# use local file
owen.data <- read.table(file = "~/Dropbox/Postdoc/2019-12-29_BE2020/Owen/41467_2018_6796_MOESM8_ESM.txt")


# Rename columns
colnames(owen.data) <- as.character(sapply(colnames(owen.data), function(n){paste(unlist(strsplit(n, "_"))[3:5], collapse = "_")}))

# Owen metadata
# owen.meta <- read.table(url("https://static-content.springer.com/esm/art%3A10.1038%2Fs41467-018-06796-9/MediaObjects/41467_2018_6796_MOESM9_ESM.txt"), header = TRUE)
# read local file
owen.meta <- read.table(file = "~/Dropbox/Postdoc/2019-12-29_BE2020/Owen/41467_2018_6796_MOESM9_ESM.txt", header = TRUE)

# Reorder cells based on metadata
owen.data <- owen.data[,as.character(owen.meta$sample_id)]
```

## Preporcessing of Owen et al data

We will now generate a `SingleCellExperiment` object that contains the Owen et al data.
To allow correct comparisons, we will perform quality assesment and filtering on the Owen at al data.

```{r}
# Remove genes that contain NA
owen.data <- owen.data[!is.na(rowSums(owen.data)),]

# Remove ERCC counts 
owen.data <- owen.data[!grepl("ERCC", rownames(owen.data)),]

# Build the SCE object
sce.owen <- SingleCellExperiment(assays = list(counts = as(as.matrix(owen.data), "dgCMatrix")),
                                 colData = as.data.frame(owen.meta))
# Remove low quality cells
# We will first check which cells were not assigned to specific clusters
sum(is.na(colData(sce.owen)$all_k8) & (!is.na(colData(sce.owen)$duodenum_k4) | 
                                         !is.na(colData(sce.owen)$gastric_k3) | 
                                         !is.na(colData(sce.owen)$oesophagus_k4) |
                                         !is.na(colData(sce.owen)$barrett_k4) | 
                                         !is.na(colData(sce.owen)$normal_oesophagus_k5) | 
                                         !is.na(colData(sce.owen)$gland_cells_k3)))

table(sce.owen$tissue[apply(colData(sce.owen)[,6:12], 1, function(n){sum(is.na(n))/7}) == 1])
table(sce.owen$tissue[apply(colData(sce.owen)[,6:12], 1, function(n){sum(is.na(n))/7}) != 1])

# The coloumn data contains the cluster ID of each cell
# If the cell is not part of any cluster, we remove them
sce.owen <- sce.owen[,apply(colData(sce.owen)[,6:12], 1, function(n){sum(is.na(n))/7}) != 1]

# Visualize quality
sce.owen <- calculateQCMetrics(sce.owen)

ggplot(as.data.frame(colData(sce.owen))) +
  geom_point(aes(total_features_by_counts, log10_total_counts, colour = tissue))
ggplot(as.data.frame(colData(sce.owen))) +
  geom_point(aes(total_features_by_counts, log10_total_counts, colour = all_k8))

# Remove cells with few genes expressed (blanks as these will distort the normalization)
sce.owen <- sce.owen[,colData(sce.owen)$total_features_by_counts > 1000]

# Normalize the data
cluster <- quickCluster(sce.owen)#, method = "igraph", irlba.args = c("work" = 100))
sce.owen <- computeSumFactors(sce.owen, clusters=cluster)
sce.owen <- logNormCounts(sce.owen, log = TRUE)

# Visualize owen data
sce.owen <- runTSNE(sce.owen)

ggplot(data.frame(tsne1 = reducedDims(sce.owen)$TSNE[,1],
                  tsne2 = reducedDims(sce.owen)$TSNE[,2],
                  info = sce.owen$tissue)) +
  geom_point(aes(tsne1, tsne2, colour = info))

ggplot(data.frame(tsne1 = reducedDims(sce.owen)$TSNE[,1],
                  tsne2 = reducedDims(sce.owen)$TSNE[,2],
                  info = sce.owen$patient)) +
  geom_point(aes(tsne1, tsne2, colour = info))

ggplot(data.frame(tsne1 = reducedDims(sce.owen)$TSNE[,1],
                  tsne2 = reducedDims(sce.owen)$TSNE[,2],
                  info = as.factor(sce.owen$all_k8))) +
  geom_point(aes(tsne1, tsne2, colour = info))

ggplot(data.frame(tsne1 = reducedDims(sce.owen)$TSNE[,1],
                  tsne2 = reducedDims(sce.owen)$TSNE[,2],
                  info = as.factor(sce.owen$gland_cells_k3))) +
  geom_point(aes(tsne1, tsne2, colour = info))
```

# Map owen data onto our data

In the next step, we use the mnn mapping approach to merge our data with the data from Owen et al. 

```{r}
# Match rownames
genes <- intersect(rownames(sce.owen), rownames(sce))
sce.owen <- sce.owen[genes,]
sce <- sce[genes,]

# Exclude contaminating cells
sce <- sce[,sce$include]

# Generate list of SCE object for batch correction
sce.list <- split.sce(sce, unique(sce$Sample), colData.name = "Sample")

# Order sce objects for batch correction

# Order sce object by size
sce.list <- sce.list[order(unlist(lapply(sce.list, ncol)), decreasing = TRUE)]

n <- names(sce.list)
sce.list <- sce.list[c(which(grepl("NSCJ_out", n)), which(grepl("BSCJ_out", n)), 
                       which(grepl("NE_out", n)), which(grepl("NG_out", n)),
                       which(grepl("ND_out",n)),
                       which(grepl("BE_out", n)), which(grepl("SMG_out", n)))]


# Split Owen data into list
owen.list <- split.sce(sce.owen, unique(sce.owen$patient), colData.name = "patient")
owen.list <- lapply(owen.list, function(n){split.sce(n, unique(n$tissue), colData.name = "tissue")})
owen.list <- unlist(owen.list)

# Remove batches that contain fewer than 10 cells
owen.list <- owen.list[lapply(owen.list, ncol) > 10]

# We remove PtB.Oesophagus and PtB.Gastric

# Sort list for mapping
# We exclude the brain cells since they would disrupt the mapping process
# They could be included if we had the batch information
owen.list <- owen.list[c("PtA.Oesophagus", "PtD.Oesophagus", "PtE.Oesophagus", "PtF.Oesophagus",
                         "PtA.Gastric", "PtC.Gastric", "PtD.Gastric",
                         "PtA.Barrett's", "PtC.Barrett's", "PtD.Barrett's",  "PtB.Barrett's",
                         "PtA.Duodenum", "PtC.Duodenum", "PtD.Duodenum", "PtB.Duodenum", "Control.Brain")]

# Collect tissue information
tissues <- unlist(lapply(sce.list, function(n){n$Tissue}))
tissues.all <- c(tissues, as.character(unlist(lapply(owen.list, function(n){n$tissue}))))

# Add Owen data to sce
sce.list.all <- c(sce.list, owen.list)
set.seed(12345)
corrected <- batch.correction(sce.list.all)

# Visualize results
set.seed(123)
tsne <- Rtsne(t(corrected), pca = FALSE, perplexity = 100)
# UMAP <- umap(t(corrected))
# Extend the colour vector
owen_vector <- vector(length = length(unique(sce.owen$tissue)))
names(owen_vector) <- unique(sce.owen$tissue)
owen_vector["Barrett's"] <- metadata(sce)$colour_vector["BE"]
owen_vector["Oesophagus"] <- "darkred"
owen_vector["Gastric"] <- metadata(sce)$colour_vector["NG"]
owen_vector["Duodenum"] <- metadata(sce)$colour_vector["ND"]
owen_vector["Brain"] <- "black"

colour_vector <- c(metadata(sce)$colour_vector, 
                   owen_vector)
colour_vector["NE"]<-"darkred"

# Number of cells in owen dataset
n.owen <- sum(unlist(lapply(owen.list, ncol)))


# get the immune clusters:
# Clustering on corrected data
g <- buildSNNGraph(corrected, k = 10)
clusters <- igraph::cluster_louvain(g)$membership

# Check what clusters overlap with nonepithelial cell types
tmp<-reshape2::dcast(plyr::count(cbind(clusters[1:(ncol(corrected)-n.owen)],sce$tissue_type)), formula = x.1 ~ x.2, fill = 0)
tmp<-tmp$x.1[tmp$NonEpithelial == apply(as.matrix(tmp[,2:5]), 1, max)]
# View(tmp)
# Exclude immune and stromal clusters
ImmuneTF <- clusters
ImmuneTF[1:(ncol(corrected)-n.owen)] <- ifelse(ImmuneTF[1:(ncol(corrected)-n.owen)] %in% tmp, "nonepi", "epi")
ImmuneTF[(ncol(corrected)-n.owen+1):ncol(corrected)] <-"epi"

owen.all.tissues <- ggplot() +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[1:(ncol(corrected)-n.owen),1],
    tsne2 = tsne$Y[1:(ncol(corrected)-n.owen),2],
    tissue = tissues.all[1:(ncol(corrected)-n.owen)],
    ImmuneTF =ImmuneTF[1:(ncol(corrected)-n.owen)]
  ), 
  aes(tsne1, tsne2, colour = tissue, alpha = ImmuneTF), size = 1) +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[(ncol(corrected)-n.owen+1):ncol(corrected),1],
    tsne2 = tsne$Y[(ncol(corrected)-n.owen+1):ncol(corrected),2],
    tissue = tissues.all[(ncol(corrected)-n.owen+1):ncol(corrected)],
    ImmuneTF =ImmuneTF[(ncol(corrected)-n.owen+1):ncol(corrected)]
  ), 
  aes(tsne1, tsne2, alpha = ImmuneTF), size = 2, colour = "black") +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[(ncol(corrected)-n.owen+1):ncol(corrected),1],
    tsne2 = tsne$Y[(ncol(corrected)-n.owen+1):ncol(corrected),2],
    tissue = tissues.all[(ncol(corrected)-n.owen+1):ncol(corrected)],
    ImmuneTF =ImmuneTF[(ncol(corrected)-n.owen+1):ncol(corrected)]
  ), 
  aes(tsne1, tsne2, colour = tissue, alpha = ImmuneTF), size = 1) + 
  scale_color_manual(values = colour_vector) +
  scale_alpha_manual(values = c("epi" = 1 , "nonepi" = 0.05)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))
owen.all.tissues




# Visualize tissue composition of gland like cells
tissue.gland <- c(rep(NA, length(tissues)), 
                  as.character(unlist(lapply(owen.list, function(n){n$gland_cells_k3}))))
gland.groups.tissues <- ggplot() +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[1:(ncol(corrected)-n.owen),1],
    tsne2 = tsne$Y[1:(ncol(corrected)-n.owen),2],
    tissue = tissues.all[1:(ncol(corrected)-n.owen)],
    ImmuneTF =ImmuneTF[1:(ncol(corrected)-n.owen)]
  ), 
  aes(tsne1, tsne2, colour = tissue, alpha = ImmuneTF), size = 1) +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[!is.na(tissue.gland),1],
    tsne2 = tsne$Y[!is.na(tissue.gland),2],
    ImmuneTF =ImmuneTF[!is.na(tissue.gland)]
    ), 
    aes(tsne1, tsne2, alpha = ImmuneTF), size = 2, colour = "black") +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[!is.na(tissue.gland),1],
    tsne2 = tsne$Y[!is.na(tissue.gland),2],
    tissue = tissues.all[!is.na(tissue.gland)],
    ImmuneTF =ImmuneTF[!is.na(tissue.gland)]
  ), 
  aes(tsne1, tsne2, colour = tissue, alpha = ImmuneTF), size = 1) + 
  scale_color_manual(values = colour_vector) +
  scale_alpha_manual(values = c("epi" = 1 , "nonepi" = 0.05)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))
gland.groups.tissues


# Visualize tissue composition of gland like cells showing only our SMG and Owen glandlike cells
ImmuneTF[1:(ncol(corrected)-n.owen)][!(tissues.all[1:(ncol(corrected)-n.owen)] %in% c("SMG"))] <- "nonepi"


tissue.gland <- c(rep(NA, length(tissues)), 
                  as.character(unlist(lapply(owen.list, function(n){n$gland_cells_k3}))))
gland.only.groups.tissues <- ggplot() +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[1:(ncol(corrected)-n.owen),1],
    tsne2 = tsne$Y[1:(ncol(corrected)-n.owen),2],
    tissue = tissues.all[1:(ncol(corrected)-n.owen)],
    ImmuneTF =ImmuneTF[1:(ncol(corrected)-n.owen)]
  ), 
  aes(tsne1, tsne2, colour = tissue, alpha = ImmuneTF), size = 1) +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[!is.na(tissue.gland),1],
    tsne2 = tsne$Y[!is.na(tissue.gland),2],
    ImmuneTF =ImmuneTF[!is.na(tissue.gland)]
    ), 
    aes(tsne1, tsne2, alpha = ImmuneTF), size = 2, colour = "black") +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[!is.na(tissue.gland),1],
    tsne2 = tsne$Y[!is.na(tissue.gland),2],
    tissue = tissues.all[!is.na(tissue.gland)],
    ImmuneTF =ImmuneTF[!is.na(tissue.gland)]
  ), 
  aes(tsne1, tsne2, colour = tissue, alpha = ImmuneTF), size = 1) + 
  scale_color_manual(values = colour_vector) +
  scale_alpha_manual(values = c("epi" = 1 , "nonepi" = 0.005)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))
gland.only.groups.tissues


# Save plots
ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Supplementary_figures/S5/All_owen_data.pdf", owen.all.tissues, width = 6, height = 5, useDingbats = FALSE)
ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Supplementary_figures/S5/Glandlike_owen_data.pdf", gland.groups.tissues, width = 6, height = 5, useDingbats = FALSE)
ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Supplementary_figures/S5/Glandlike_and_SMG_owen_data.pdf", gland.only.groups.tissues, width = 6, height = 5, useDingbats = FALSE)
```

# Comparison to HCA data

We next compare our data to normal oesophagus samples from different patients.
This data has been generated in the context of the Human Cell Atlas.
Here, we want to check whether gland cells can be detected by simply sampling thousands of cells from normal oesophagus.

We remove one patient due to differences in the dissociation protocol.

```{r}
library(Seurat)
# Read in the HCA data
HCA <- readRDS("~/Dropbox/Postdoc/2019-12-29_BE2020/Teichman_data/Data/oesophagus.rds")
HCA.meta <- read.csv("~/Dropbox/Postdoc/2019-12-29_BE2020/Teichman_data/Data/oesophagus_meta.csv",
                     stringsAsFactors = FALSE)

# Visualize the data
ggplot(data.frame(umap1 = Embeddings(HCA, reduction = "umap")[,1],
                  umap2 = Embeddings(HCA, reduction = "umap")[,2],
                  cell_type = HCA$Celltypes)) + 
  geom_point(aes(umap1, umap2, colour = cell_type)) +
  scale_colour_manual(values = c(brewer.pal(12, "Set3"), brewer.pal(8, "Set1")))

# Create SingelCellExperiment
HCA.sce <- SingleCellExperiment(assays = list(counts = GetAssayData(HCA, 
                                                                    assay = "RNA", slot = "data")),
                                colData = HCA@meta.data)

# Normalization based on known cell types
HCA.sce <- computeSumFactors(HCA.sce, clusters=HCA.sce$Celltypes)
HCA.sce <- logNormCounts(HCA.sce, log = TRUE)

# Marker genes
ggplot(data.frame(umap1 = Embeddings(HCA, reduction = "umap")[,1],
                  umap2 = Embeddings(HCA, reduction = "umap")[,2],
                  gene = logcounts(HCA.sce)["KRT4",])) + 
  geom_point(aes(umap1, umap2, colour = gene)) +
  scale_colour_viridis()

ggplot(data.frame(umap1 = Embeddings(HCA, reduction = "umap")[,1],
                  umap2 = Embeddings(HCA, reduction = "umap")[,2],
                  gene = logcounts(HCA.sce)["KRT5",])) + 
  geom_point(aes(umap1, umap2, colour = gene)) +
  scale_colour_viridis()

saveRDS(HCA.sce, file = "~/Dropbox/Postdoc/2019-12-29_BE2020/Teichman_data/Data/HCAprocessed.rds")

# HCA.sce <-readRDS("~/Dropbox/Postdoc/2019-12-29_BE2020/Teichman_data/Data/HCAprocessed.rds")

# Read in our data
sce <- readRDS("~/Dropbox/Postdoc/2019-12-29_BE2020/All_corrected_sce_filtered.rds")

# For our data, we select the normal oesophagus and gland cells
sce <- sce[,sce$Tissue == "NE" | sce$Tissue == "SMG"]

# Select the same set of genes for both datasets
genes <- intersect(rownames(HCA.sce), rowData(sce)$Symbol)
HCA.sce <- HCA.sce[genes,]
sce <- sce[match(genes, rowData(sce)$Symbol),]
rownames(sce) <- genes

# Split the data into individual batches
sce.list.ours <- split.sce(sce, groups = unique(sce$Sample), colData.name = "Sample")
# Order sce object by size
sce.list.ours <- sce.list.ours[order(unlist(lapply(sce.list.ours, ncol)), decreasing = TRUE)]

sce.list.HCA <- split.sce(HCA.sce, unique(HCA.sce$donor_time), colData.name = "donor_time")
# Order sce object by size
sce.list.HCA <- sce.list.HCA[order(unlist(lapply(sce.list.HCA, ncol)), decreasing = TRUE)]

# We will use the teichman data first here
sce.list <- c(sce.list.HCA, sce.list.ours)

# Batch correction and merging
corrected <- batch.correction(sce.list)
saveRDS(corrected, file = "~/Dropbox/Postdoc/2019-12-29_BE2020/Teichman_data/Data/HCATcorrected.rds")

# corrected <- readRDS("~/Dropbox/Postdoc/2019-12-29_BE2020/Teichman_data/Data/HCATcorrected.rds")

sce <- do.call("cbind", sce.list.ours)
HCA.sce <- do.call("cbind", sce.list.HCA)

# Generate tissue vector - we colour the gland cells based on their cell type
tissues.all <- c(rep("NE", ncol(HCA.sce)), sce$Tissue)
tissues.all[tissues.all == "SMG"] <- sce$cell_type[sce$Tissue == "SMG"]

# Generate new colour vector
colour_vector <- vector(length = length(unique(tissues.all)))
names(colour_vector) <- unique(tissues.all)
colour_vector["Immune"] <- "grey40"
colour_vector["Unknown.Doublets"] <- "white"
colour_vector["Mucous"] <- "saddlebrown"
colour_vector["Oncocytes"] <- "burlywood3"
colour_vector["Stromal"] <- "grey60"
# colour_vector["Nonepithelial"] <- "grey80"
colour_vector["Duct_Intercalating"] <- "burlywood4"
colour_vector["Squamous_Esophagus"] <- "black"
colour_vector["Myo-epithelial"] <- "brown"
# colour_vector["Dendritic"] <- "grey20"
colour_vector["NE"] <- "darkred"

# Now the cell types
types.all <- c(as.character(HCA.sce$Celltypes), sce$cell_type)

colour_vector.type <- vector(length = length(unique(types.all)))
names(colour_vector.type) <- unique(types.all)
# colour_vector.type["Fibroblast"] <- "grey40"
colour_vector.type["Mucous"] <- "saddlebrown"
colour_vector.type["Oncocytes"] <- "burlywood3"
# colour_vector.type["Doublets.unknown"] <- "white"
# colour_vector.type["Endothelial"] <- "grey60"
# colour_vector.type["Nonepithelial"] <- "grey80"
colour_vector.type["Duct_Intercalating"] <- "burlywood4"
colour_vector.type["Squamous_Esophagus"] <- "black"
colour_vector.type["Myo-epithelial"] <- "brown"
# colour_vector.type["Dendritic"] <- "grey20"
# colour_vector.type["Unknown"] <- "grey"
colour_vector.type["Superficial"] <- colorRampPalette(c("white", "dark red"))(10)[10]
colour_vector.type["Basal"] <- colorRampPalette(c("white", "dark red"))(10)[4]
colour_vector.type["Intermediate"] <- colorRampPalette(c("white", "dark red"))(10)[7]
# colour_vector.type["Dividing"] <- colorRampPalette(c("white", "dark red"))(10)[2]
colour_vector.type["Epi_suprabasal"] <- colorRampPalette(c("white", "dark red"))(10)[4]
colour_vector.type["Epi_upper"] <- colorRampPalette(c("white", "dark red"))(10)[10]
colour_vector.type["Epi_stratified"] <- colorRampPalette(c("white", "dark red"))(10)[7]
colour_vector.type["Epi_dividing"] <- colorRampPalette(c("white", "dark red"))(10)[2]
colour_vector.type["Epi_basal"] <- unique(HCA.meta$cellcols[HCA.meta$cell.types.f == "Epi_basal"])
colour_vector.type["T_CD4"] <- unique(HCA.meta$cellcols[HCA.meta$cell.types.f == "T_CD4"])
colour_vector.type["Dendritic_Cells"] <- "grey20"
colour_vector.type["T_CD8"] <- unique(HCA.meta$cellcols[HCA.meta$cell.types.f == "T_CD8"])
colour_vector.type["Mono_macro"] <- unique(HCA.meta$cellcols[HCA.meta$cell.types.f == "Mono_macro"])
colour_vector.type["NK_T_CD8_Cytotoxic"] <- unique(HCA.meta$cellcols[HCA.meta$cell.types.f == "NK_T_CD8_Cytotoxic"])
colour_vector.type["B_CD27pos"] <- unique(HCA.meta$cellcols[HCA.meta$cell.types.f == "B_CD27pos"])
colour_vector.type["B_CD27neg"] <- unique(HCA.meta$cellcols[HCA.meta$cell.types.f == "B_CD27neg"])
colour_vector.type["Mast_cell"] <- unique(HCA.meta$cellcols[HCA.meta$cell.types.f == "Mast_cell"])
colour_vector.type["Stroma"] <- unique(HCA.meta$cellcols[HCA.meta$cell.types.f == "Stroma"])
colour_vector.type["Lymph_vessel"] <- unique(HCA.meta$cellcols[HCA.meta$cell.types.f == "Lymph_vessel"])
colour_vector.type["Blood_vessel"] <- unique(HCA.meta$cellcols[HCA.meta$cell.types.f == "Blood_vessel"])
colour_vector.type["Glands_duct"] <- "burlywood4"
colour_vector.type["Glands_mucous"] <- "saddlebrown"
colour_vector.type["Immune"] <- "grey40"
colour_vector.type["Unknown.Doublets"] <- "white"
colour_vector.type["Stromal"] <- "grey60"
colour_vector.type["Suprabasal"] <- colorRampPalette(c("white", "dark red"))(10)[6]

# Visualization of mapped data
# 12345 is ok
set.seed(123)
tsne <- Rtsne(t(corrected), perplexity = 200, pca = FALSE)
saveRDS(tsne, file = "~/Dropbox/Postdoc/2019-12-29_BE2020/Teichman_data/Data/HCATSNE.rds")

# tsne <- readRDS("~/Dropbox/Postdoc/2019-12-29_BE2020/Teichman_data/Data/HCATSNE.rds")

# Visualization
HCA.all.cell_type <- ggplot() +
  # HCA cells
  geom_point(data = data.frame(
    tsne1 = tsne$Y[1:ncol(HCA.sce),1],
    tsne2 = tsne$Y[1:ncol(HCA.sce),2],
    cell_type = types.all[1:ncol(HCA.sce)]
  ), 
  aes(tsne1, tsne2, colour = cell_type), size = 0.5) +
  # Our cells on top
  # Black background
  geom_point(data = data.frame(
    tsne1 = tsne$Y[(ncol(HCA.sce)+1):ncol(corrected),1],
    tsne2 = tsne$Y[(ncol(HCA.sce)+1):ncol(corrected),2],
    cell_type = types.all[(ncol(HCA.sce)+1):ncol(corrected)]
  ), 
  aes(tsne1, tsne2), size = 2, colour = "black", alpha = 0.5) +
  # coloured dots
  geom_point(data = data.frame(
    tsne1 = tsne$Y[(ncol(HCA.sce)+1):ncol(corrected),1],
    tsne2 = tsne$Y[(ncol(HCA.sce)+1):ncol(corrected),2],
    cell_type = types.all[(ncol(HCA.sce)+1):ncol(corrected)]
  ), 
  aes(tsne1, tsne2, colour = cell_type), size = 1, alpha = 0.5) + 
  scale_color_manual(values = colour_vector.type) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))
HCA.all.cell_type
HCA.all.tissue <- ggplot() +
  # HCA cells
  geom_point(data = data.frame(
    tsne1 = tsne$Y[1:ncol(HCA.sce),1],
    tsne2 = tsne$Y[1:ncol(HCA.sce),2],
    tissue = tissues.all[1:ncol(HCA.sce)]
  ), 
  aes(tsne1, tsne2, colour = tissue), size = 0.5) +
  # Our cells on top
  # Black background
  geom_point(data = data.frame(
    tsne1 = tsne$Y[(ncol(HCA.sce)+1):ncol(corrected),1],
    tsne2 = tsne$Y[(ncol(HCA.sce)+1):ncol(corrected),2],
    tissue = tissues.all[(ncol(HCA.sce)+1):ncol(corrected)]
  ), 
  aes(tsne1, tsne2), size = 2, colour = "black") +
  # coloured dots
  geom_point(data = data.frame(
    tsne1 = tsne$Y[(ncol(HCA.sce)+1):ncol(corrected),1],
    tsne2 = tsne$Y[(ncol(HCA.sce)+1):ncol(corrected),2],
    tissue = tissues.all[(ncol(HCA.sce)+1):ncol(corrected)]
  ), 
  aes(tsne1, tsne2, colour = tissue), size = 1) + 
  scale_color_manual(values = colour_vector) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))
HCA.all.tissue
# Visualize marker genes
ggplot(data.frame(tsne1 = tsne$Y[,1],
                  tsne2 = tsne$Y[,2],
                  gene = c(logcounts(HCA.sce)["KRT5",], 
                           logcounts(sce)[rowData(sce)$Symbol == "KRT5",]))) +
  geom_point(aes(tsne1, tsne2, colour = gene)) +
  scale_colour_viridis()

ggplot(data.frame(tsne1 = tsne$Y[,1],
                  tsne2 = tsne$Y[,2],
                  gene = c(logcounts(HCA.sce)["KRT4",], 
                           logcounts(sce)[rowData(sce)$Symbol == "KRT4",]))) +
  geom_point(aes(tsne1, tsne2, colour = gene)) +
  scale_colour_viridis()

ggplot(data.frame(tsne1 = tsne$Y[,1],
                  tsne2 = tsne$Y[,2],
                  gene = c(logcounts(HCA.sce)["COL17A1",], 
                           logcounts(sce)[rowData(sce)$Symbol == "COL17A1",]))) +
  geom_point(aes(tsne1, tsne2, colour = gene)) +
  scale_colour_viridis()

gene<-"KRT8"
ggplot(data.frame(tsne1 = tsne$Y[,1],
                  tsne2 = tsne$Y[,2],
                  gene = c(logcounts(HCA.sce)[gene,], 
                           logcounts(sce)[rowData(sce)$Symbol == gene,]))) +
  geom_point(aes(tsne1, tsne2, colour = gene)) +
  scale_colour_viridis()

#only HCA data
ggplot(data.frame(tsne1 = tsne$Y[1:ncol(HCA.sce),1],
                  tsne2 = tsne$Y[1:ncol(HCA.sce),2],
                  gene = c(logcounts(HCA.sce)[gene,]))) +
  geom_point(aes(tsne1, tsne2, colour = gene)) +
  scale_colour_viridis()

#only our data
ggplot(data.frame(tsne1 = tsne$Y[(ncol(HCA.sce)+1):nrow(tsne$Y),1],
                  tsne2 = tsne$Y[(ncol(HCA.sce)+1):nrow(tsne$Y),2],
                  gene = c(logcounts(sce)[rowData(sce)$Symbol == gene,]))) +
  geom_point(aes(tsne1, tsne2, colour = gene)) +
  scale_colour_viridis()





# Now only the our cells
HCA.our <- ggplot() +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[(ncol(HCA.sce)+1):nrow(tsne$Y),1],
    tsne2 = tsne$Y[(ncol(HCA.sce)+1):nrow(tsne$Y),2],
    cell_type = types.all[(ncol(HCA.sce)+1):nrow(tsne$Y)]
  ), 
  aes(tsne1, tsne2, colour = cell_type), size = 0.5)+ 
  scale_color_manual(values = colour_vector.type) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))
HCA.our

# Now only the HCA cells
HCA.only <- ggplot() +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[1:ncol(HCA.sce),1],
    tsne2 = tsne$Y[1:ncol(HCA.sce),2],
    cell_type = types.all[1:ncol(HCA.sce)]
  ), 
  aes(tsne1, tsne2, colour = cell_type), size = 0.5)+ 
  scale_color_manual(values = colour_vector.type) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))
HCA.only
ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Supplementary_figures/S5/HCA_all.pdf", HCA.all.cell_type, width = 10, height = 8, useDingbats = FALSE)
ggsave("~/Dropbox/Postdoc/2019-12-29_BE2020/Figures/Supplementary_figures/S5/HCA_only.pdf", HCA.only, width = 10, height = 8, useDingbats = FALSE)
```

# End Matter

To finish get session info:

```{r Endnote, include=TRUE, echo=TRUE, warning=FALSE, eval=TRUE, message=FALSE, tidy=TRUE}
sessionInfo()
```
